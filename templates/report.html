<!doctype html>
<html>
<head>
	<title>OpenDash</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap -->
	<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />

	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
</head>
<body>

	<div class="container">

	<div class="jumbotron">
		<div id="version-selector"></div>
		<div class="row">
			<div class="col-md-9">
				<div id="chart-div" style="height: 500px;"></div>
			</div>

			<div class="col-md-3">
				<form id="source-form" role="form">
				  <div class="form-group">
				    <label for="Dataset">Dataset</label>
				    <select id="dataset-list" class="form-control">
					  
					</select>
				  </div>
				  <div class="form-group">
				    <label for="Dataset">Graph</label>
				    <select id ="graph-list" class="form-control">
					
					</select>
				  </div>
				  <button type="submit" class="btn btn-default">Submit</button>
				</form>

				<div id="chart-configuration"></div>
			</div>
		</div>
	</div>	

	<script src="https://code.jquery.com/jquery.js"></script>
	<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>	

	<script>
		google.load("visualization", "1", {packages:["corechart"]});

		function getEndpoints() {
			var endpoints = new Array();

			endpoints[0] = 'http://test1';
			endpoints[1] = 'http://test2';
			endpoints[2] = 'http://test3';

			return endpoints;
		};

		function getGraphs(endpointID) {
			var graphs = new Array();

			if (endpointID == '0') {

				graphs[0] = 'http://test1/graph1';
				graphs[1] = 'http://test1/graph2';

			}

			return graphs;
		};

		function getDescription(endpointID, graphID) {
			var desc = [];

			desc[0] = {};
			desc[0].classURI = 'http://test1/class1';
			desc[0].properties = [];
			desc[0].properties[0] = {};
			desc[0].properties[0].uri = 'http://test1/property1';
			desc[0].properties[0].datatype = 'http://test1/type1';
			desc[0].properties[1] = {};
			desc[0].properties[1].uri = 'http://test1/property2';
			desc[0].properties[1].datatype = 'http://test1/type2';

			desc[1] = {};
			desc[1].classURI = 'http://test1/class2';
			desc[1].properties = [];
			desc[1].properties[0] = {};
			desc[1].properties[0].uri = 'http://test1/property3';
			desc[1].properties[0].datatype = 'http://test1/type1';
			desc[1].properties[1] = {};
			desc[1].properties[1].uri = 'http://test1/property4';
			desc[1].properties[1].datatype = 'http://test1/type2';

			return desc;
		};

		function updateGraphList(endpoint) {
			graphs = getGraphs(endpoint.val());

			$("#graph-list").empty();

			for (var index = 0; index < graphs.length; index++) {
				$("#graph-list").append(new Option(graphs[index], index));
			}
		};

		function processClass(desc, descID, id) {
			var classObj = desc[descID];

			$("#xvalues-list-" + id).empty();
			$("#yvalues-list-" + id).empty();
			for (var index = 0; index < classObj.properties.length; index++) {
				$("#xvalues-list-" + id).append(new Option(classObj.properties[index].uri, descID + ":" + index));	
				$("#yvalues-list-" + id).append(new Option(classObj.properties[index].uri, descID + ":" + index));
			}
		}

		function getConfID(event) {
			var source = event.target || event.srcElement;
			var res = source.id.split("-");
			return res[res.length - 1];
		};

		function updateData(desc, conf) {
			conf.data = [Math.random() * 1000, Math.random() * 1000, Math.random() * 1000, Math.random() * 1000];
		};

		function getXValues() {
			return ['2004', '2005', '2006', '2007'];
		};

		function getTitles() {
			var titles = []
			titles.push("X axis");

			var index = 0;
			for (var key in chart) {
				titles.push("Title " + index);
				index++;
			}

			return titles;
		}

		function updateChart(desc, conf) {
			updateData(desc, conf);

			drawChart();
		};

		function drawChart() {
			var arrayData = []
			arrayData.push(getTitles());
			var xvalues = getXValues();
			for (var rowIndex = 0; rowIndex < xvalues.length; rowIndex++) {
				var row = [];
				row.push(xvalues[rowIndex]);

				for (var key in chart)
					row.push(chart[key].data[rowIndex]);

				arrayData.push(row);
			}

			var data = google.visualization.arrayToDataTable(arrayData);

			var options = {
				title: 'Company Performance'
			};

			var lineChart = new google.visualization.LineChart(document.getElementById('chart-div'));
			lineChart.draw(data, options);
		}

		function addConfiguration(desc, id) {
			var snippet = 	'<div id="configuration-' + id + '">' + 
								'<button id="remove-conf-button-' + id + '"type="button" class="btn btn-danger">X</button>' +
								'<label>Class:</label>' + 
                        		'<select id="class-list-' + id + '" class="form-control">' +
					  
								'</select>' +

								'<label>X:</label>' +
                        		'<select id="xvalues-list-' + id + '" class="form-control">' +
					  
								'</select>' +

								'<label>Y:</label>' +
                        		'<select id="yvalues-list-' + id + '" class="form-control">' +
					  
								'</select>' +
							'</div>';

			$('#chart-configuration').append(snippet);

			$("#class-list-" + id).empty();
			for (var index = 0; index < desc.length; index++) {
				$("#class-list-" + id).append(new Option(desc[index].classURI, index));	
			}

			$("#class-list-" + id).change(function(event) {
				var confID = getConfID(event);

				chart[confID].classURI = desc[$(this).val()].classURI;
				chart[confID].xvalue = desc[$(this).val()].properties[0].uri;
				chart[confID].yvalue = desc[$(this).val()].properties[0].uri;
				processClass(desc, $(this).val(), id)

				updateChart(desc, chart[confID]);
			});

			$("#xvalues-list-" + id).change(function(event) {
				var confID = getConfID(event);
				var res = $(this).val().split(":");

				chart[confID].xvalue = desc[res[0]].properties[res[1]].uri;

				updateChart(desc, chart[confID]);
			});

			$("#yvalues-list-" + id).change(function(event) {
				var confID = getConfID(event);
				var res = $(this).val().split(":");

				chart[confID].yvalue = desc[res[0]].properties[res[1]].uri;

				updateChart(desc, chart[confID]);
			});

			$("#remove-conf-button-" + id).click(function(event) {
				$('#configuration-' + id).remove();

				var confID = getConfID(event);
				delete chart[confID];

				if (Object.keys(chart).length > 0)
					drawChart();
				else
					$("#chart-div").empty();
			});

			processClass(desc, 0, id);

			var conf = {}
			conf.classURI = desc[0].classURI;
			conf.xvalue = desc[0].properties[0].uri;
			conf.yvalue = desc[0].properties[0].uri;

			return conf;
		}

		var chart = {}
		var id = 0;

		function processSource() {
			var endpointID = $("#dataset-list").val();
			var graphID = $("#graph-list").val();

			var desc = getDescription(endpointID, graphID);

			$("#chart-configuration").append('<button id="add-button" type="button" class="btn btn-primary">+</button>');
			$("#add-button").click(function(event) {
				var conf = addConfiguration(desc, id++);				
				chart[id - 1] = conf;

				updateChart(desc, conf);
			});
		};

		function init() {
			var endpoints = getEndpoints();

			$("#dataset-list").change(function() {
				updateGraphList($(this));					
			});

			$("#dataset-list").empty();

			for (var index = 0; index < endpoints.length; index++) {
				$("#dataset-list").append(new Option(endpoints[index], index));
			}

			updateGraphList($('#dataset-list').val('0'))

			$("#source-form").submit(function(event) {
				processSource();

  				event.preventDefault();
			});
		};

		window.onload = init();
	</script>
</body>
</html>